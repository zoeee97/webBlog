import{_ as e,X as t,Y as o,$ as n,a0 as a,a1 as p,Z as c,C as i}from"./framework-1e167b4e.js";const r={},l=c(`<h1 id="解决ios设备浏览器页面回退但内容不刷新导致的问题" tabindex="-1"><a class="header-anchor" href="#解决ios设备浏览器页面回退但内容不刷新导致的问题" aria-hidden="true">#</a> 解决ios设备浏览器页面回退但内容不刷新导致的问题</h1><h2 id="场景描述" tabindex="-1"><a class="header-anchor" href="#场景描述" aria-hidden="true">#</a> 场景描述</h2><p><strong>项目情况</strong>：项目是一个php前后端不分离项目，分为移动端和pc端，但用的基本是一套代码，在每个页面中调用判断当前是否为移动端的函数去动态的加载pc或移动端所需的css、js和dom结构代码。</p><p><strong>问题描述</strong>：今天碰到的提测的一个bug是：设备在操作部分页面后点击浏览器后退按钮，会直接显示pc端的样式，需手动刷新页面才显示移动端样式，用户交互体验差。</p><p><strong>定位问题</strong>：经过排查后发现，只有ios设备在用浏览器浏览的时候会出现以上问题，用微信内置浏览器查看没有上述问题，安卓设备也没有上述问题。 并且后续通过打印信息，发现页面回退时并没有再触发判断是否为移动端的函数，也因此我可以将问题定位到，页面后退后，并没有触发页面刷新，而是直接走了缓存。</p><h2 id="解决方法" tabindex="-1"><a class="header-anchor" href="#解决方法" aria-hidden="true">#</a> 解决方法</h2><p>在php页面中引入我们要写的reload.js，if语句使得只有移动端会引入该js文件【is_mobile函数判断是否为移动端】：</p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>@<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">is_mobile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string double-quoted-string">&quot;{{URL::asset(&#39;web/js/reload.js&#39;)}}&quot;</span> id<span class="token operator">=</span><span class="token string double-quoted-string">&quot;script&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
@<span class="token keyword">endif</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>reload.js:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pageshow&#39;</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>persisted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果页面是读取缓存</span>
    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//刷新页面</span>
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>onpageshow 区别于onload事件。onload 事件在页面第一次加载时触发， onpageshow 事件在每次加载页面时触发。 因此读取浏览器缓存时，onload 事件不会触发。 为了查看页面是直接从服务器上载入还是从缓存中读取，你可以使用 PageTransitionEvent 对象的 persisted 属性来判断。 如果页面从浏览器的缓存中读取该属性返回 ture，否则返回 false。</p><h2 id="产生原因" tabindex="-1"><a class="header-anchor" href="#产生原因" aria-hidden="true">#</a> 产生原因：</h2><blockquote><p>bfcache，即 BACk-forWARD cache，可称为往返缓存，可以在用户使用浏览器的 后退 和 前进 按钮时加快页面的转换速度。这个缓存不仅保存页面数据，还保存了 DOM 和 JS 的状态，实际上是将整个页面都保存在内存里。如果页面位于bfcache中，那么再次打开该页面就不会触发 onload事件。这是 HTML5 世代浏览器新增的特性之一。 这就产生了一个问题，如果希望用户每次打开这个页面的时候都能够获取到最新的资源，因为 bfcache 的存在，不做特殊的处理这个效果就无法达到。</p></blockquote><p>chromium已经移除了bfcache，但基于Webkit的iOS仍然保留了这一特性。【←根据苹果 AppStore 指南，要求iOS 上的第三方浏览器应用程序必须使用苹果自己的 WebKit 浏览器引擎】</p><h2 id="一点疑惑" tabindex="-1"><a class="header-anchor" href="#一点疑惑" aria-hidden="true">#</a> 一点疑惑</h2><p>缓存也应该缓存原来的页面，也就是移动端页面，为什么反而缓存了pc的页面？</p><hr>`,17),d={href:"https://dandelioncloud.cn/article/details/1488190140932804610",target:"_blank",rel:"noopener noreferrer"};function u(k,h){const s=i("ExternalLinkIcon");return t(),o("div",null,[l,n("p",null,[a("参考文章： "),n("a",d,[a("浏览器往返缓存（Back/Forward cache）问题的分析与解决"),p(s)])])])}const b=e(r,[["render",u],["__file","解决ios设备浏览器页面回退但内容不刷新导致的问题.html.vue"]]);export{b as default};
