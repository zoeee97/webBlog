import{_ as e,X as p,Y as o,$ as n,a0 as s,a1 as t,Z as c,C as u}from"./framework-1e167b4e.js";const l={},i=c(`<h1 id="采用animate-css的多页面应用在ios设备回退页面时动画播放两次的解决方案" tabindex="-1"><a class="header-anchor" href="#采用animate-css的多页面应用在ios设备回退页面时动画播放两次的解决方案" aria-hidden="true">#</a> 采用animate.css的多页面应用在ios设备回退页面时动画播放两次的解决方案</h1><h2 id="情景描述" tabindex="-1"><a class="header-anchor" href="#情景描述" aria-hidden="true">#</a> 情景描述</h2><p>该项目是一个多页面且都应用了animate.css实现动画效果的纯移动端项目。在实际真机测试时发现，在ios设备中，当用户点击浏览器回退/前进按钮时，或者location.href跳转到此前已经访问过的页面时，动画会重复播放两次。考虑到这次的问题和上次开发遇到的ios页面缓存问题很像，因此当即考虑是否是因为bfcache的缘故。</p><h2 id="问题确定" tabindex="-1"><a class="header-anchor" href="#问题确定" aria-hidden="true">#</a> 问题确定</h2><p>在将点击【返回】按钮的a标签url中加上了时间戳参数后，页面正常显示，动画只播放了一次，因此可以确定为出现bug的原因就是bfcache。</p><blockquote><p>不同的浏览器在对当前窗口打开历史记录中的前一个页面的表现上并不统一，这和浏览器的实现以及页面本身的设置有关系。</p></blockquote><h2 id="解决方法" tabindex="-1"><a class="header-anchor" href="#解决方法" aria-hidden="true">#</a> 解决方法</h2><p>尝试过的方法有：</p><ol><li>html通过meta标签去设置HTTP的头部信息</li></ol><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Cache-Control<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>no-cache, no-store, must-revalidate<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Pragma<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>no-cache<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Expires<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（但在我的项目里没有起到作用</p><ol start="2"><li>url加时间戳，让它不缓存</li></ol><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 监听浏览器后退和前进事件</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;DOMContentLoaded&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;popstate&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> timestamp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">+=</span> <span class="token string">&quot;?&quot;</span> <span class="token operator">+</span> timestamp<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;pageshow&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span>navigation<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 清除当前页面的历史状态</span>
    history<span class="token punctuation">.</span><span class="token function">replaceState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> location<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>但是其实也不是很好使（？ 感觉这个写法还有待改进</p><h2 id="参考" tabindex="-1"><a class="header-anchor" href="#参考" aria-hidden="true">#</a> 参考</h2>`,15),r={href:"https://stupidcode.net/blog/2016/08/29/bfcache/",target:"_blank",rel:"noopener noreferrer"},k={href:"https://blog.51cto.com/lilinoscar/5902090",target:"_blank",rel:"noopener noreferrer"};function d(m,v){const a=u("ExternalLinkIcon");return p(),o("div",null,[i,n("p",null,[n("a",r,[s("BFCache相关 "),t(a)]),n("a",k,[s("IOS微信浏览器返回事件popstate监听"),t(a)])])])}const _=e(l,[["render",d],["__file","采用animate.css的多页面应用在ios设备回退页面时动画播放两次的解决方案.html.vue"]]);export{_ as default};
